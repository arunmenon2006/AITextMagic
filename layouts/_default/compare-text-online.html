{{ define "main" }}

<style>
  /* Smooth scrollbars */
  * { scrollbar-width: thin; scrollbar-color: #9CA3AF transparent; }
  *::-webkit-scrollbar { width: 10px; height: 10px; }
  *::-webkit-scrollbar-thumb { background: #9CA3AF; border-radius: 8px; }
  
  .btn { 
    display: inline-flex; 
    align-items: center; 
    gap: 0.5rem; 
    border-radius: 1rem; 
    padding: 0.5rem 0.75rem; 
    font-size: 0.875rem; 
    font-weight: 500; 
    box-shadow: 0 10px 25px -10px rgba(0,0,0,0.2); 
    transition: all 0.2s ease; 
    cursor: pointer;
    border: none;
  }
  .btn:hover { 
    transform: translateY(-1px); 
    box-shadow: 0 20px 40px -15px rgba(0,0,0,0.3); 
  }
  .btn-ghost { 
    background: white; 
    color: #374151; 
    border: 1px solid #E5E7EB; 
  }
  .btn-primary { 
    background: #4F46E5; 
    color: white; 
  }
  .btn-secondary { 
    background: #6B7280; 
    color: white; 
  }
  .btn-danger { 
    background: #DC2626; 
    color: white; 
  }
  .btn-success { 
    background: #059669; 
    color: white; 
  }
  
  .chip { 
    border-radius: 0.75rem; 
    background: #F3F4F6; 
    padding: 0.25rem 0.5rem; 
    font-size: 0.75rem; 
    color: #374151; 
  }
  
  .tooltip { position: relative; }
  .tooltip:hover::after { 
    content: attr(data-tip); 
    position: absolute; 
    top: 110%; 
    left: 50%; 
    transform: translateX(-50%); 
    background: rgba(0,0,0,0.85); 
    color: white; 
    padding: 6px 8px; 
    border-radius: 8px; 
    white-space: nowrap; 
    font-size: 12px; 
    z-index: 30; 
  }
  
  .dropzone { 
    border: 2px dashed #CBD5E1; 
    border-radius: 1rem;
    padding: 1rem;
    text-align: center;
    color: #6B7280;
    font-size: 0.875rem;
    margin-top: 0.75rem;
    transition: all 0.2s ease;
  }
  .dropzone.dragover { 
    border-color: #6366F1; 
    background: rgba(99,102,241,0.07); 
  }
  
  .hidden-input { 
    position: absolute; 
    inset: 0; 
    opacity: 0; 
    cursor: pointer; 
  }
  
  .kbd { 
    border-radius: 0.5rem; 
    border: 1px solid #D1D5DB; 
    background: #F9FAFB; 
    padding: 0.125rem 0.375rem; 
    font-size: 0.75rem; 
    font-weight: 600; 
    color: #374151; 
  }
  
  .badge { 
    border-radius: 9999px; 
    padding: 0.125rem 0.5rem; 
    font-size: 0.75rem; 
    font-weight: 500;
  }
  
  .badge-primary { background: #EEF2FF; color: #4338CA; }
  .badge-success { background: #D1FAE5; color: #065F46; }
  .badge-danger { background: #FEE2E2; color: #991B1B; }
  .badge-warning { background: #FEF3C7; color: #92400E; }
  
  .toggle { 
    display: inline-flex; 
    align-items: center; 
    gap: 0.5rem; 
    cursor: pointer; 
    user-select: none; 
  }
  
  .toggle input[type="checkbox"] { display: none; }
  
  /* Dark mode styles */
  .dark .btn-ghost { 
    background: #374151; 
    color: #F9FAFB; 
    border-color: #4B5563; 
  }
  .dark .chip { 
    background: #374151; 
    color: #F9FAFB; 
  }
  .dark .kbd { 
    background: #374151; 
    color: #F9FAFB; 
    border-color: #4B5563; 
  }
  .dark .badge-primary { 
    background: #312E81; 
    color: #C7D2FE; 
  }
  .dark .badge-success { 
    background: #064E3B; 
    color: #A7F3D0; 
  }
  .dark .badge-danger { 
    background: #7F1D1D; 
    color: #FCA5A5; 
  }
  .dark .badge-warning { 
    background: #78350F; 
    color: #FDE68A; 
  }
  .dark .dropzone { 
    border-color: #4B5563; 
    color: #9CA3AF; 
  }
  .dark .dropzone.dragover { 
    border-color: #6366F1; 
    background: rgba(99,102,241,0.1); 
  }
  
  /* Layout styles */
  .text-compare-container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 1rem;
  }
  
  .toolbar-grid {
    margin-top: 1rem;
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
  
  @media (min-width: 768px) {
    .toolbar-grid {
      grid-template-columns: 2fr 1fr;
    }
  }
  
  .toolbar-buttons {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0.5rem;
  }
  
  .toolbar-options {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  
  .mode-select {
    border-radius: 0.75rem;
    border: 1px solid #D1D5DB;
    background: white;
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
  }
  
  .dark .mode-select {
    background: #1F2937;
    border-color: #4B5563;
    color: white;
  }
  
  .editors-grid {
    margin-top: 1rem;
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  
  @media (min-width: 1024px) {
    .editors-grid {
      grid-template-columns: 1fr 1fr;
    }
  }
  
  .editor-section {
    border-radius: 1.5rem;
    border: 1px solid #E5E7EB;
    background: white;
    box-shadow: 0 10px 25px -10px rgba(0,0,0,0.2);
    overflow: hidden;
  }
  
  .dark .editor-section {
    border-color: #374151;
    background: #1F2937;
  }
  
  .section-header {
    padding: 1rem;
    background: #F9FAFB;
    border-bottom: 1px solid #E5E7EB;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  
  .dark .section-header {
    background: #111827;
    border-color: #374151;
  }
  
  .section-title {
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: #6B7280;
    margin: 0;
  }
  
  .dark .section-title {
    color: #9CA3AF;
  }
  
  .text-input {
    width: 100%;
    height: 300px;
    padding: 1rem;
    border: none;
    background: transparent;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Monaco, Menlo, Consolas, 'Liberation Mono', 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.6;
    resize: vertical;
    outline: none;
  }
  
  .dark .text-input {
    color: white;
  }
  
  .text-input::placeholder {
    color: #9CA3AF;
  }
  
  .input-actions {
    padding: 0.75rem 1rem;
    background: #F9FAFB;
    border-top: 1px solid #E5E7EB;
    display: flex;
    gap: 0.5rem;
    align-items: center;
  }
  
  .dark .input-actions {
    background: #111827;
    border-color: #374151;
  }
  
  .results-section {
    margin-top: 1rem;
    border-radius: 1.5rem;
    border: 1px solid #E5E7EB;
    background: white;
    box-shadow: 0 10px 25px -10px rgba(0,0,0,0.2);
    overflow: hidden;
  }
  
  .dark .results-section {
    border-color: #374151;
    background: #1F2937;
  }
  
  .results-header {
    padding: 1rem;
    background: #F9FAFB;
    border-bottom: 1px solid #E5E7EB;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 1rem;
  }
  
  .dark .results-header {
    background: #111827;
    border-color: #374151;
  }
  
  .summary {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }
  
  .view-toggle {
    display: flex;
    gap: 0.25rem;
    background: #F3F4F6;
    border-radius: 0.75rem;
    padding: 0.25rem;
  }
  
  .dark .view-toggle {
    background: #374151;
  }
  
  .view-btn {
    padding: 0.375rem 0.75rem;
    border-radius: 0.5rem;
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    border: none;
    background: transparent;
    color: #6B7280;
    transition: all 0.2s ease;
  }
  
  .view-btn.active {
    background: white;
    color: #4F46E5;
    box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
  }
  
  .dark .view-btn.active {
    background: #1F2937;
    color: #A78BFA;
  }
  
  .results-content {
    max-height: 500px;
    overflow: auto;
  }
  
  .results-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    min-height: 300px;
  }
  
  .results-column {
    padding: 1rem;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Monaco, Menlo, Consolas, 'Liberation Mono', 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
    overflow: auto;
  }
  
  .results-column:first-child {
    border-right: 1px solid #E5E7EB;
  }
  
  .dark .results-column:first-child {
    border-color: #374151;
  }
  
  .results-unified {
    padding: 1rem;
    font-family: ui-monospace, SFMono-Regular, 'SF Mono', Monaco, Menlo, Consolas, 'Liberation Mono', 'Courier New', monospace;
    font-size: 0.875rem;
    line-height: 1.6;
    white-space: pre-wrap;
    word-break: break-word;
  }
  
  /* Diff highlighting */
  .diff-added {
    background: rgba(16, 185, 129, 0.1);
    color: #059669;
    border-left: 3px solid #10B981;
    padding: 0.125rem 0.25rem;
    margin: 0 -0.25rem;
  }
  
  .diff-removed {
    background: rgba(239, 68, 68, 0.1);
    color: #DC2626;
    border-left: 3px solid #EF4444;
    padding: 0.125rem 0.25rem;
    margin: 0 -0.25rem;
  }
  
  .diff-unchanged {
    opacity: 0.7;
  }
  
  /* Loading and empty states */
  .loading {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    color: #6B7280;
    flex-direction: column;
    gap: 1rem;
  }
  
  .spinner {
    width: 24px;
    height: 24px;
    border: 2px solid #E5E7EB;
    border-top: 2px solid #4F46E5;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #6B7280;
  }
  
  .footer-info {
    margin-top: 1.5rem;
    border-radius: 1.5rem;
    border: 1px solid #E5E7EB;
    background: white;
    padding: 1rem;
    font-size: 0.875rem;
    color: #6B7280;
    box-shadow: 0 10px 25px -10px rgba(0,0,0,0.2);
  }
  
  .dark .footer-info {
    border-color: #374151;
    background: #1F2937;
    color: #9CA3AF;
  }
  
  .toast {
    position: fixed;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 50;
    border-radius: 1rem;
    background: #1F2937;
    padding: 0.75rem 1.25rem;
    font-size: 0.875rem;
    color: white;
    box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
    pointer-events: none;
    display: none;
  }
  
  /* Responsive */
  @media (max-width: 1023px) {
    .results-grid {
      grid-template-columns: 1fr;
    }
    .results-column:first-child {
      border-right: none;
      border-bottom: 1px solid #E5E7EB;
    }
    .dark .results-column:first-child {
      border-color: #374151;
    }
  }
  
  @media (max-width: 767px) {
    .toolbar-buttons,
    .toolbar-options {
      justify-content: center;
    }
    .summary {
      justify-content: center;
    }
  }
</style>

<!-- Main Content -->
<div class="text-compare-container">
  <!-- Toolbar -->
  <div class="toolbar-grid">
    <div class="toolbar-buttons">
      <button id="compareBtn" class="btn btn-primary tooltip" data-tip="Compare texts and show differences">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
        </svg>
        Compare
      </button>
      <button id="swapBtn" class="btn btn-ghost tooltip" data-tip="Swap left and right texts">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/>
        </svg>
        Swap
      </button>
      <button id="copyLeftBtn" class="btn btn-ghost tooltip" data-tip="Copy original text">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v16h13c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 18H8V7h11v16z"/>
        </svg>
        Copy Left
      </button>
      <button id="copyRightBtn" class="btn btn-ghost tooltip" data-tip="Copy modified text">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v16h13c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 18H8V7h11v16z"/>
        </svg>
        Copy Right
      </button>
      <label class="btn btn-ghost tooltip relative" data-tip="Upload text file">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M19 15v4H5v-4H3v4c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-4h-2zM11 7.83L8.41 10.41L7 9l5-5 5 5-1.41 1.41L13 7.83V16h-2z"/>
        </svg>
        Upload
        <input id="fileInput" type="file" accept=".txt,.md,.json,text/*" class="hidden-input" />
      </label>
      <button id="downloadBtn" class="btn btn-ghost tooltip" data-tip="Download comparison results">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M5 20h14v-2H5v2zM12 2L6.5 7.5h3.5V15h4V7.5H17.5z"/>
        </svg>
        Download
      </button>
      <button id="sampleBtn" class="btn btn-secondary tooltip" data-tip="Load sample text for testing">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/>
        </svg>
        Sample
      </button>
      <button id="clearBtn" class="btn btn-danger tooltip" data-tip="Clear all text">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M3 6h18l-1.5 14H4.5L3 6zm2.5 2L7 16h10l1.5-8H5.5zM9 8v6h2V8H9zm4 0v6h2V8h-2z"/>
        </svg>
        Clear
      </button>
    </div>
    <div class="toolbar-options">
      <div style="display: flex; align-items: center; gap: 0.5rem;">
        <span style="font-size: 0.875rem; color: #6B7280;">Mode:</span>
        <select id="modeSelect" class="mode-select">
          <option value="word">Word-level</option>
          <option value="char">Character-level</option>
          <option value="line">Line-level</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Text Editors -->
  <div class="editors-grid">
    <!-- Original Text -->
    <div class="editor-section">
      <div class="section-header">
        <h2 class="section-title">Original Text</h2>
        <span id="leftStats" class="badge badge-primary">Words: 0</span>
      </div>
      <textarea 
        id="leftInput" 
        class="text-input"
        placeholder="Paste or type your original text here..."
      ></textarea>
      <div class="input-actions">
        <button id="copyLeftAction" class="btn btn-ghost">
          📋 Copy
        </button>
        <button id="downloadLeftAction" class="btn btn-ghost">
          💾 Download
        </button>
      </div>
      <div id="leftDropzone" class="dropzone">Drag & drop a text file here</div>
    </div>

    <!-- Modified Text -->
    <div class="editor-section">
      <div class="section-header">
        <h2 class="section-title">Modified Text</h2>
        <span id="rightStats" class="badge badge-primary">Words: 0</span>
      </div>
      <textarea 
        id="rightInput" 
        class="text-input"
        placeholder="Paste or type your modified text here..."
      ></textarea>
      <div class="input-actions">
        <button id="copyRightAction" class="btn btn-ghost">
          📋 Copy
        </button>
        <button id="downloadRightAction" class="btn btn-ghost">
          💾 Download
        </button>
      </div>
      <div id="rightDropzone" class="dropzone">Drag & drop a text file here</div>
    </div>
  </div>

  <!-- Results -->
  <div class="results-section">
    <div class="results-header">
      <div class="summary">
        <span class="section-title">Summary:</span>
        <div id="summaryBadges">
          <span class="badge badge-primary">No comparison yet</span>
        </div>
      </div>
      <div class="view-toggle">
        <button id="sideViewBtn" class="view-btn active">Side-by-side</button>
        <button id="unifiedViewBtn" class="view-btn">Unified</button>
      </div>
    </div>
    <div class="results-content" id="resultsContent">
      <div class="empty-state">
        <p>📝 Enter text above and click <strong>Compare</strong> to see differences</p>
        <p style="font-size: 0.75rem; margin-top: 0.5rem; opacity: 0.7;">
          Pro tip: Try the sample data to get started!
        </p>
      </div>
    </div>
  </div>

  <!-- Footer Info -->
  <div class="footer-info">
    <p style="margin-bottom: 0.5rem;">Your text is processed <strong>entirely in your browser</strong>. Nothing is uploaded to any server.</p>
    <p>Shortcuts: <span class="kbd">⌘/Ctrl</span> + <span class="kbd">Enter</span> = Compare • <span class="kbd">⌘/Ctrl</span> + <span class="kbd">K</span> = Clear</p>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<script>
// ---- Utilities ----
const $ = (sel) => document.querySelector(sel);
const showToast = (msg, ms = 2000) => {
  const t = $('#toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(() => t.style.display = 'none', ms);
};

// ---- Text Comparison Logic ----
function tokenize(text, mode) {
  if (!text) return [];
  
  switch (mode) {
    case 'word':
      return text.split(/(\s+)/).filter(Boolean).map(s => ({tok: s, raw: s}));
    case 'char':
      return Array.from(text).map(c => ({tok: c, raw: c}));
    case 'line':
      return text.split(/(\n)/).filter(Boolean).map(s => ({tok: s, raw: s}));
    default:
      return [];
  }
}

function diffLCS(aTokens, bTokens) {
  const a = aTokens.map(t => t.tok);
  const b = bTokens.map(t => t.tok);
  const n = a.length;
  const m = b.length;
  
  // Build LCS table
  const dp = Array.from({length: n + 1}, () => Array(m + 1).fill(0));
  for (let i = n - 1; i >= 0; i--) {
    for (let j = m - 1; j >= 0; j--) {
      if (a[i] === b[j]) {
        dp[i][j] = dp[i + 1][j + 1] + 1;
      } else {
        dp[i][j] = Math.max(dp[i + 1][j], dp[i][j + 1]);
      }
    }
  }
  
  // Extract operations
  const ops = [];
  let i = 0, j = 0;
  while (i < n || j < m) {
    if (i < n && j < m && a[i] === b[j]) {
      ops.push({type: '=', a: aTokens[i], b: bTokens[j]});
      i++; j++;
    } else if (j < m && (i === n || dp[i][j + 1] >= dp[i + 1][j])) {
      ops.push({type: '+', b: bTokens[j]});
      j++;
    } else if (i < n && (j === m || dp[i][j + 1] < dp[i + 1][j])) {
      ops.push({type: '-', a: aTokens[i]});
      i++;
    }
  }
  
  return ops;
}

function countOps(ops) {
  let add = 0, rem = 0, eq = 0;
  ops.forEach(o => {
    if (o.type === '+') add++;
    else if (o.type === '-') rem++;
    else eq++;
  });
  return {add, rem, eq};
}

function renderSideBySide(ops) {
  const leftResult = document.createElement('div');
  const rightResult = document.createElement('div');
  leftResult.className = 'results-column';
  rightResult.className = 'results-column';
  
  ops.forEach(op => {
    const leftSpan = document.createElement('span');
    const rightSpan = document.createElement('span');
    
    if (op.type === '=') {
      leftSpan.className = 'diff-unchanged';
      leftSpan.textContent = op.a.raw;
      rightSpan.className = 'diff-unchanged';
      rightSpan.textContent = op.b.raw;
    } else if (op.type === '-') {
      leftSpan.className = 'diff-removed';
      leftSpan.textContent = op.a.raw;
      rightSpan.textContent = '';
    } else if (op.type === '+') {
      leftSpan.textContent = '';
      rightSpan.className = 'diff-added';
      rightSpan.textContent = op.b.raw;
    }
    
    leftResult.appendChild(leftSpan);
    rightResult.appendChild(rightSpan);
  });
  
  const container = document.createElement('div');
  container.className = 'results-grid';
  container